# PaperSpecimen

## Descrizione Progetto
**Cornice digitale da frigo** per M5Paper che visualizza glifi tipografici casuali da font TrueType/OpenType. Si aggiorna automaticamente ogni 15 minuti con font e glifi random, funzionando come specimen tipografico sempre diverso. Ottimizzato per massima durata batteria (30-44 giorni) con deep sleep intelligente.

## Hardware
- **Device**: M5Paper (ESP32-based e-ink display, versione standard non S3)
- **Display**: 960x540 pixels, 4.7" e-ink, orientamento VERTICALE (540x960)
- **Storage**: microSD card FAT32 per font files
- **Batteria**: 1150mAh LiPo 4.35V
- **Pulsanti utilizzati**:
  - BtnL/BtnR (rotella laterale su/giù): cambio font/peso mantenendo stesso glifo
  - BtnP (rotella pressione centrale): nuovo glifo casuale con font corrente
- **Componenti disabilitati** (per risparmio batteria):
  - Touchscreen GT911
  - WiFi
  - Bluetooth
  - Sensore temperatura/umidità SHT30
  - Alimentazione sensori esterni

## Stack Tecnologico
- **Platform**: ESP32 (espressif32)
- **Framework**: Arduino
- **IDE**: VSCode + PlatformIO
- **Librerie principali**:
  - M5EPD v0.1.5 (include FreeType per rendering font TTF)
  - SD library (per accesso microSD)
  - esp_sleep.h (per deep sleep e timer wakeup)

## Configurazione PlatformIO
File: `platformio.ini`
```ini
[env:m5paper]
platform = espressif32
board = m5stack-fire
framework = arduino
board_build.partitions = default.csv
build_flags =
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
lib_deps =
    m5stack/M5EPD@^0.1.5
```

## Stato Progetto: ✅ COMPLETATO - Cornice da Frigo v2.0

### Build Info
- **Compilazione**: SUCCESS
- **Flash utilizzata**: 84.7% (1,109,529 / 1,310,720 bytes)
- **RAM utilizzata**: 1.1% (49,792 bytes / 4,521,984 bytes)
- **File binario**: `.pio/build/m5paper/firmware.bin`

### Funzionalità Implementate
✅ Scansione automatica font dalla microSD (skip file nascosti macOS `._*`)
✅ Caricamento dinamico font con FreeType
✅ Rendering glifi **375px** con anti-aliasing 16-bit
✅ Dual render cache (24px per label, 375px per glifo)
✅ Navigazione font con rotella (su/giù mantiene glifo)
✅ Generazione random glifi da 9 Unicode ranges comuni
✅ Refresh intelligente (5 partial + 10s threshold per auto full refresh)
✅ Display info: nome font (top), Unicode codepoint (bottom)
✅ **Deep sleep intelligente** (~1mA dopo 10s idle)
✅ **Auto-wake ogni 15 minuti** con ESP32 timer
✅ **Font + glifo random** ad ogni auto-wake
✅ **Wake rapido su button press** (no boot screen)
✅ **Low battery protection** (<5% mostra icona e shutdown)
✅ **Power optimization** (tutti i sensori inutilizzati disabilitati)
✅ Gestione errori con feedback visivo

### Durata Batteria Stimata
**30-44 giorni** con:
- Auto-wake ogni 15 minuti (96 eventi/giorno)
- Uso manuale 1-2 volte/giorno
- Deep sleep ~1mA
- Consumi auto-wake: ~13.3mAh/giorno
- Consumi totali: ~26-38mAh/giorno

## Come Usarlo

### Setup MicroSD
1. Formatta microSD in **FAT32**
2. Crea cartella `/fonts` nella root
3. Copia file `.ttf` o `.otf` nella cartella fonts
4. Inserisci microSD nell'M5Paper

Esempio struttura:
```
/
└── fonts/
    ├── Helvetica-Regular.ttf
    ├── Helvetica-Bold.ttf
    ├── ABCDinamo-Regular.ttf
    └── YourFont.otf
```

### Aggiornamento Font su MicroSD
**IMPORTANTE**: I font vengono scansionati solo al cold boot, non ad ogni wake.

**Per aggiungere/rimuovere/modificare font**:
1. Rimuovi microSD (anche con dispositivo in deep sleep)
2. Modifica i font nella cartella `/fonts`
3. Reinserisci microSD nell'M5Paper
4. **Premi reset fisico sul retro del dispositivo**
5. Il dispositivo ri-scansiona tutti i font e riparte

**Perché serve il reset**:
- La scansione SD avviene solo in `setup()` (cold boot)
- Ad ogni auto-wake (15 min) non viene ri-scansionata per risparmiare batteria
- Senza reset, il dispositivo continuerebbe a usare la lista di font vecchia

### Compilazione e Upload
```bash
# Compila
pio run

# Upload su M5Paper
pio run --target upload

# Monitor seriale (debug)
pio device monitor -b 115200
```

## Comportamento e Regole

### 1. Cold Boot (Reset fisico o prima accensione)
**Trigger**: Reset button sul retro + power button centrale
- Mostra schermata "PaperSpecimen, Booting..."
- Inizializza WiFi OFF, Bluetooth OFF, Sensori OFF
- Scansiona font dalla microSD
- Carica primo font disponibile
- Mostra glifo casuale
- Entra in modalità normale

### 2. Modalità Normale (Dispositivo attivo)
**Controlli manuali**:
- **BtnL (giù)**: Font precedente, **stesso glifo**
- **BtnR (su)**: Font successivo, **stesso glifo**
- **BtnP (centro)**: Glifo random, **stesso font**

**Regole refresh**:
- Partial refresh (UPDATE_MODE_GL16) per ogni cambio
- Auto full refresh dopo 5 partial OPPURE dopo 10s dal primo partial
- Full refresh pulisce ghosting e resetta contatori

**Timer idle**:
- Dopo 10 secondi dall'ultimo full refresh senza input → **Deep Sleep**

### 3. Deep Sleep Mode
**Stato**:
- ESP32 in deep sleep (~1mA consumo)
- Display IT8951 in StandBy (mantiene immagine visibile)
- GPIO2 in hold (mantiene alimentazione)
- RTC BM8563 attivo ma non usato
- Stato salvato in RTC memory (font index, glyph codepoint)

**Wake sources**:
1. **ESP32 timer**: esattamente 15 minuti
2. **GPIO38 (button centrale)**: pressione utente

### 4. Auto-Wake (Timer 15 minuti)
**Comportamento**:
- Wake cause: `ESP_SLEEP_WAKEUP_TIMER`
- **NO boot screen**
- Controlla batteria (se <5% → Low Battery Shutdown)
- Genera **font completamente random** (diverso dal precedente)
- Genera **glifo completamente random**
- Renderizza con partial refresh
- Dopo 10s (o 5 partial/10s timer) → full refresh automatico
- Torna in deep sleep dopo 10s idle

**Scopo**: Cornice da frigo che cambia specimen automaticamente

### 5. Wake Manuale (Button Press)
**Comportamento**:
- Wake cause: `ESP_SLEEP_WAKEUP_EXT0` (GPIO38)
- **NO boot screen**
- Controlla batteria (se <5% → Low Battery Shutdown)
- **Ripristina stato precedente** (stesso font, stesso glifo)
- Renderizza esattamente quello che c'era prima
- Modalità normale attiva
- Pulsanti funzionanti normalmente

**Scopo**: Riprendi esattamente dove avevi lasciato

### 6. Low Battery Protection (<5%)
**Trigger**: Batteria voltage < 3345mV (5% carica)
**Controllo**: Solo al wake da deep sleep (ogni 15 min o button press)

**Comportamento**:
1. Schermo cleared completamente (full refresh)
2. Disegna icona batteria scarica stilizzata:
   - Rettangolo 120x60px con tip 10x20px (stile AA battery)
   - Barra sottile 6px (5% indicator)
   - Testo "LOW BATTERY" e "Please charge device"
3. Mostra per 2 secondi
4. **Shutdown completo** (`M5.shutdown()`)
   - Solo RTC rimane alimentato (~1.5µA)
   - Display mantiene icona visibile (e-ink persistence)

**Riattivazione**: Solo con power button dopo ricarica USB → Cold boot

### 7. Gestione Errori
**SD Card Error**:
- Messaggio "SD CARD ERROR"
- Istruzioni per inserire microSD
- Device halted (loop infinito)

**No Fonts Found**:
- Messaggio "NO FONTS FOUND"
- Istruzioni per aggiungere .ttf/.otf in /fonts
- Device halted

**Font Load Error**:
- Messaggio "FONT LOAD ERROR"
- Suggerimento controllare serial output
- Device halted

## Note Tecniche

### Display E-Paper IT8951 (16 livelli di grigio)
- **Risoluzione**: 960x540 pixels (540x960 vertical), 4.7"
- **Grayscale**: 16 livelli (4-bit) per anti-aliasing ottimale
- **Orientamento**: `SetRotation(90)` per verticale

**Update Modes Utilizzati**:
| Mode | Ghosting | Tempo | Livelli Grigio | Uso |
|------|----------|-------|----------------|-----|
| `UPDATE_MODE_GL16` | Medium | 450ms | 16 | Partial refresh normale |
| `UPDATE_MODE_GC16` | Very Low | 450ms | 16 | Full refresh pulizia ghosting |

**Strategia Refresh**:
1. Partial (GL16) per cambio glifo/font rapido
2. Full (GC16) automatico dopo 5 partial o 10s
3. Minimizza flickering, massimizza qualità

### Font Rendering
**Formati supportati**: TrueType (.ttf), OpenType (.otf)

**Dual Cache System**:
```cpp
canvas.createRender(24, 64);    // Labels: 24px, 64 glyphs cache
canvas.createRender(375, 12);   // Main glyph: 375px, 12 glyphs cache
```

**Rendering Pipeline**:
1. `canvas.loadFont(path, SD)` - carica font da microSD
2. `canvas.createRender(size, cache)` - setup renderer + cache
3. `canvas.setTextSize(size)` - switch tra 24px e 375px
4. `canvas.drawString(text, x, y)` - rendering con FreeType
5. `canvas.pushCanvas(0, 0, mode)` - push to display

**Color Mapping** (4-bit grayscale):
- `0` = bianco (background)
- `15` = nero (text)
- `12` = grigio (icone batteria)

### Unicode Ranges per Random Glyph
9 ranges comuni (biased verso caratteri più probabili):
```cpp
{0x0041, 0x005A, "Latin Uppercase"},    // A-Z
{0x0061, 0x007A, "Latin Lowercase"},    // a-z
{0x0030, 0x0039, "Digits"},             // 0-9
{0x0021, 0x002F, "Basic Punctuation 1"},// !"#$%&'()*+,-./
{0x003A, 0x0040, "Basic Punctuation 2"},// :;<=>?@
{0x005B, 0x0060, "Basic Punctuation 3"},// [\]^_`
{0x007B, 0x007E, "Basic Punctuation 4"},// {|}~
{0x00A1, 0x00BF, "Latin-1 Punctuation"},// ¡-¿
{0x00C0, 0x00FF, "Latin-1 Letters"},    // À-ÿ accented
```

### Power Management Dettagliato

**Inizializzazione Ottimizzata**:
```cpp
M5.begin(false, true, true, false, true);
// touchEnable=false       → Touch disabled
// SDEnable=true           → SD enabled (font loading)
// SerialEnable=true       → Serial debug enabled
// BatteryADCEnable=false  → Battery ADC on-demand only
// I2CEnable=true          → I2C for RTC (unused but init)

WiFi.mode(WIFI_OFF);      // WiFi OFF
btStop();                 // Bluetooth OFF
M5.disableEXTPower();     // External sensors OFF (SHT30, etc)
```

**Deep Sleep Entry**:
```cpp
M5.EPD.StandBy();                          // Display controller standby
gpio_hold_en(GPIO_NUM_2);                  // Hold GPIO2 HIGH
gpio_deep_sleep_hold_en();                 // Enable hold in deep sleep
esp_sleep_enable_ext0_wakeup(GPIO_NUM_38, LOW); // Button wake
esp_sleep_enable_timer_wakeup(900000000ULL);    // 15min timer
esp_deep_sleep_start();                    // Enter deep sleep
```

**Wake Detection**:
```cpp
esp_sleep_wakeup_cause_t cause = esp_sleep_get_wakeup_cause();

if (cause == ESP_SLEEP_WAKEUP_TIMER) {
    // Auto-wake: random font + random glyph
} else if (cause == ESP_SLEEP_WAKEUP_EXT0) {
    // Button wake: restore state
} else {
    // Cold boot: show boot screen
}
```

**Consumi Misurati/Stimati**:
- Cold boot: ~160mA per 3-5 secondi
- Active mode: ~160mA (rendering + SD access)
- Deep sleep: ~0.5-1mA (ESP32 + voltage regulators)
- Shutdown: ~1.5µA (solo RTC, dopo low battery)

### RTC Memory State Persistence
```cpp
RTC_DATA_ATTR struct {
    bool isValid;                  // State validity flag
    int currentFontIndex;          // Font index (0-N)
    uint32_t currentGlyphCodepoint;// Glyph Unicode (e.g., 0x0041)
} rtcState;
```
Sopravvive a deep sleep, perso solo su reset hardware.

### Pulsanti M5Paper
- **BtnL**: GPIO (rotella giù)
- **BtnR**: GPIO (rotella su)
- **BtnP**: GPIO38 (rotella centro, anche wake pin)
- Debounce: 300ms delay software
- Wake trigger: GPIO38 LOW (button press)

## Output Seriale (Debug)
Monitor seriale 115200 baud mostra:
```
=== PaperSpecimen Cold Boot ===
WiFi and Bluetooth disabled
External sensors power disabled
Scanning for fonts...
  Found: /fonts/Helvetica-Bold.ttf
Total fonts found: 5

=== Loading font: /fonts/Helvetica-Bold.ttf ===
Creating render cache for labels (size=24, cache=64)...
Creating render cache for glyph (size=375, cache=12)...
Font loaded successfully

Rendered: A (U+0041) with font Helvetica-Bold

=== Setup Complete ===

>>> Preparing for deep sleep...
State saved: font=0, glyph=U+0041
Wake sources configured: GPIO38 (button) + Timer (15min)
>>> Entering deep sleep now...

=== PaperSpecimen Auto-Wake (Timer) ===
Woke by ESP32 timer after 15 minutes
Battery level: 87.3%
Auto-wake: Generating random font + glyph
Random font selected: 3/5
Rendered: è (U+00E8) with font ABCDinamo-Regular
```

## Troubleshooting

### Auto-wake non funziona
- ❌ RTC alarm non funziona con deep sleep + GPIO hold
- ✅ Usa ESP32 timer wakeup (`esp_sleep_enable_timer_wakeup()`)
- Verifica serial output: deve mostrare "ESP_SLEEP_WAKEUP_TIMER"

### Ghosting eccessivo
- Aumenta `MAX_PARTIAL_BEFORE_FULL` (attualmente 5)
- Riduci `FULL_REFRESH_TIMEOUT_MS` (attualmente 10000ms)

### Batteria si scarica velocemente
- Verifica serial: deve entrare in deep sleep dopo 10s
- Check: tutti i sensori disabilitati in setup
- Misura: ~1mA in sleep è normale, >10mA indica problema

### Display rimane bianco dopo wake
- Color mapping invertito: usa `fillCanvas(0)` + `setTextColor(15)`
- Verifica dual cache creation (24px + 375px)

### Font non caricati
- Controlla file nascosti macOS (`._*`) - vengono skippati
- Verifica formato FAT32 su microSD
- Serial mostra "Font load error" con dettagli

## Crediti
- **Hardware**: M5Stack M5Paper
- **Librerie**: M5EPD (include FreeType)
- **Framework**: Arduino ESP32 via PlatformIO
- **Progetto**: PaperSpecimen - Typographic Specimen Frame

## Licenza
Open source - usa come preferisci
